<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8">
    <!-- Mobile friendliness -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <style>
      :root{
        --radius: 10px;
        --pad: 10px;
        --gap: 8px;
        --border: #ddd;
        --muted: #666;
        --ok: #16a34a;
        --ok-border:#0f7a30;
        --bg-current:#ededed;
      }

      html, body { height: 100%; }
      body {
        font: 14px/1.4 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        margin: 0;
        -webkit-tap-highlight-color: transparent;
        background:#fff;
      }

      /* Layout */
      .wrap {
        display: flex;
        flex-direction: column;
        height: 100vh;
        padding: 12px;
        padding-left: max(12px, env(safe-area-inset-left));
        padding-right: max(12px, env(safe-area-inset-right));
        padding-bottom: max(12px, env(safe-area-inset-bottom));
        box-sizing: border-box;
        gap: var(--gap);
      }
      h2 { margin: 0 0 2px 0; font-weight: 700; font-size: 18px; }

      .row { display: flex; gap: 10px; align-items: center; }
      .muted { color: var(--muted); }
      .error { color: #b00020; }
      .success { color: #0a7a0a; }

      /* Controls */
      .controls {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--gap);
      }
      .field { display: flex; align-items: center; gap: 6px; }
      .field label { white-space: nowrap; }
      .controls input[type="number"] {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: #fafafa;
      }
      .controls input[disabled] { color: #444; }

      /* Buttons */
      .btn {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        background: #f5f5f5;
        cursor: pointer;
        touch-action: manipulation;
        min-height: 44px; /* mobile tap target */
        font-weight: 600;
      }
      .btn:disabled { opacity: .6; cursor: not-allowed; }
      .btn:focus-visible { outline: 2px solid #999; outline-offset: 2px; }

      /* Games list */
      .games {
        flex: 1; min-height: 0;
        overflow: auto;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: var(--pad);
        -webkit-overflow-scrolling: touch;
      }
      .games.suspense { pointer-events: none; opacity: 0.6; }

      .game {
        position: relative;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 8px;
        margin: 8px 0;
        display: flex;
        flex-direction: column;
      }
      .game.current { background: var(--bg-current); border-color: #cfcfcf; }
      .game-header { font-size: 12px; color: #555; margin-bottom: 6px; }

      /* One-row game line with responsive grid */
      .team-line {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: 12px;
        font-weight: 700;
        min-width: 0;
      }
      .team-choice {
        display: inline-flex; align-items: center; gap: 8px;
        min-width: 0;
      }
      .team-choice:first-child { justify-content: flex-end; }
      .team-choice:last-child  { justify-content: flex-start; }
      .team-choice label { white-space: nowrap; }
      .at { font-size: 12px; color: #777; }
      .logo { width: 26px; height: 26px; object-fit: contain; }
      input[type="radio"][disabled] { cursor: not-allowed; }

      /* Lives (STARS) */
      .lives { margin-top: 2px; }
      .lives .stars { display: inline-flex; gap: 2px; }
      .star { font-size: 18px; line-height: 1; color: #f59e0b; } /* amber */
      .star.lost { color: #d1d5db; } /* gray */
      .lives .label { margin-left: 6px; font-size: 12px; color: var(--muted); vertical-align: middle; }

      /* Badge */
      .badge {
        position: absolute; top: 6px; right: 8px;
        padding: 2px 8px; font-size: 11px; border-radius: 999px;
        font-weight: 600; border: 1px solid transparent;
      }
      .badge.current { background: var(--ok); color: #fff; border-color: var(--ok-border); }

      /* Radio + ghost dot */
      .radio-box{
        position: relative;
        display: inline-flex; align-items: center; justify-content: center;
        width: 18px; height: 18px; vertical-align: middle;
        flex: 0 0 18px;
      }
      .radio-box input[type="radio"]{
        width: 18px; height: 18px; margin: 0;
        position: relative; z-index: 1;
        appearance: auto; -webkit-appearance: radio;
      }
      .saved-dot{
        position: absolute; inset: 0; margin: auto;
        width: 8px; height: 8px; border-radius: 50%;
        background: #9e9e9e; pointer-events: none; z-index: 2;
        display: none;
      }
      .team-choice.saved-ghost .saved-dot{ display: block; }

      /* Hide the radio for non-selectable, non-saved */
      .team-choice.hide-radio .radio-box { visibility: hidden; width: 0; margin: 0; }
      .team-choice.hide-radio label { opacity: 0.5; }
      .team-choice.saved-ghost .radio-box{ visibility: visible; width: 18px; }

      /* Footer submit (sticky) */
      .footer {
        position: sticky; bottom: 0;
        background: #fff;
        padding-top: 4px;
        margin-bottom: env(safe-area-inset-bottom);
      }

      #identity { font-size: 12px; }

      /* -------- Mobile tweaks -------- */
      @media (max-width: 520px) {
        body { font-size: 16px; } /* prevents iOS input zoom */
        .logo { width: 28px; height: 28px; }
        .controls input[type="number"] { font-size: 16px; }
        .radio-box, .radio-box input[type="radio"] { width: 22px; height: 22px; }
        .saved-dot { width: 10px; height: 10px; }
        .btn { padding: 14px 12px; }
        .game { padding: 10px; }
        .team-line { gap: 10px; }
      }

      /* Extra-narrow fallback: allow wrapping labels, keep layout readable */
      @media (max-width: 360px) {
        .team-line { gap: 6px; }
        .team-choice { gap: 6px; }
        .logo { width: 24px; height: 24px; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h2>NFL Survivor Picker</h2>

      <!-- Identity -->
      <div id="identity" class="muted">You are: …</div>
      <!-- Lives (stars) -->
      <div id="lives" class="lives" aria-live="polite" aria-label="Lives"></div>

      <!-- Year (disabled) + Week -->
      <div class="controls">
        <div class="field">
          <label for="year">Year:</label>
          <input id="year" type="number" min="2020" step="1" disabled>
        </div>
        <div class="field">
          <label for="week">Week:</label>
          <input id="week" type="number" min="1" max="22" step="1">
        </div>
      </div>

      <!-- Load -->
      <button id="load" class="btn">Load Games</button>

      <!-- Games list -->
      <div id="gamesBox" class="games muted">Loading games…</div>

      <div class="row">
        <label><input type="checkbox" id="lockAtKickoff" checked> Lock selection at kickoff</label>
      </div>

      <!-- Submit -->
      <div class="footer">
        <button id="submit" class="btn" disabled>Submit Pick</button>
        <div id="msg" class="muted" style="margin-top:6px;"></div>
      </div>
    </div>

    <script>
      /* Silence wallet extension noise inside Docs iframe */
      (function(){
        const re = /(metamask|web3|ethereum)/i;
        window.addEventListener('unhandledrejection', e => { if (e && re.test(String(e.reason))) e.preventDefault(); });
        window.addEventListener('error', e => { if (e && re.test(String(e.message))) e.preventDefault(); }, true);
      })();

      // ----- DOM refs -----
      const yearEl = document.getElementById('year');
      const weekEl = document.getElementById('week');
      const loadBtn = document.getElementById('load');
      const submitBtn = document.getElementById('submit');
      const gamesBox = document.getElementById('gamesBox');
      const msgEl = document.getElementById('msg');
      const lockAtKickoffEl = document.getElementById('lockAtKickoff');
      const identityEl = document.getElementById('identity');
      const livesEl = document.getElementById('lives');

      // State
      let selected = null;        // [teamAbbr, oppAbbr, kickoffISO]
      let currentYear = null;
      let currentWeek = null;
      let viewerEmail = '';
      let usedTeams = new Set();  // abbreviations already used this season
      let currentPick = null;     // {team, opponent, kickoffISO, state} or null

      // Gating (prevent clicks until all checks finish)
      let gate = { survivor:false, saved:false, lock:false, uiLocked:false };
      let pickingReady = false;

      function beginGate() {
        pickingReady = false;
        gate = { survivor:false, saved:false, lock:false, uiLocked:false };
        gamesBox.classList.add('suspense');
        gamesBox.querySelectorAll('input[type="radio"][name="team"]').forEach(r => {
          r.disabled = true;
          r.dataset.gate = '1';
        });
        updateSubmitEnabled();
      }
      function maybeEnablePicking() {
        if (gate.uiLocked) return;
        if (!(gate.survivor && gate.saved && gate.lock)) return;
        enableEligibleRadiosAfterGate();
        pickingReady = true;
        gamesBox.classList.remove('suspense');
        // Ensure visuals are correct after enabling
        markSelections();
        updateSubmitEnabled();
      }
      function enableEligibleRadiosAfterGate() {
        const now = Date.now();
        const savedTeamU = currentPick && currentPick.team
          ? String(currentPick.team).toUpperCase()
          : null;

        gamesBox.querySelectorAll('input[type="radio"][name="team"]').forEach(r => {
          if (r.dataset.gate !== '1') return;
          const tc = r.closest('.team-choice');
          const abbr = String(r.dataset.team || '').toUpperCase();
          const isoMs = r.dataset.iso ? new Date(r.dataset.iso).getTime() : NaN;

          const gameStarted = Number.isFinite(isoMs) && isoMs <= now;
          const isSaved = savedTeamU && abbr === savedTeamU;
          const taken = usedTeams.has(abbr);
          const survivorBlock = taken && !isSaved;

          const hide = survivorBlock || (gameStarted && !isSaved);
          if (tc) {
            if (hide) tc.classList.add('hide-radio'); else tc.classList.remove('hide-radio');
          }
          r.disabled = hide;
          r.dataset.gate = '0';
        });
      }
      function updateSubmitEnabled() {
        const checked = gamesBox.querySelector('input[type="radio"][name="team"]:checked');
        submitBtn.disabled = gate.uiLocked || !pickingReady || !checked;
      }

      // ----- Lives UI (STARS) -----
      function renderLives(count, max = 5) {
        const stars = [];
        for (let i = 0; i < max; i++) {
          if (i < count) stars.push(`<span class="star" aria-hidden="true">★</span>`);
          else stars.push(`<span class="star lost" aria-hidden="true">☆</span>`);
        }
        livesEl.innerHTML = `<div class="stars" title="${count} of ${max} lives">${stars.join('')}</div><span class="label">${count}/${max}</span>`;
      }
      function fetchLives() {
        if (!currentYear) return;
        google.script.run
          .withSuccessHandler(({lives, max}) => renderLives(lives, max))
          .withFailureHandler(() => renderLives(0, 5))
          .getLivesForViewerPublic(currentYear);
      }

      // ----- Bootstrap -----
      function waitForGoogle(cb, tries = 0) {
        const ok = (typeof google !== 'undefined') && google.script && google.script.run;
        if (ok) return cb();
        if (tries > 120) { setError('Init timeout. Please reload.'); return; }
        setTimeout(() => waitForGoogle(cb, tries + 1), 50);
      }
      window.addEventListener('DOMContentLoaded', () => waitForGoogle(init));

      function init() {
        loadBtn.addEventListener('click', safeLoad);
        submitBtn.addEventListener('click', onSubmit);
        weekEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') safeLoad(); });

        // Identity → defaults → load
        google.script.run
          .withSuccessHandler((email) => {
            viewerEmail = email || '';
            identityEl.textContent = viewerEmail
              ? `You are: ${viewerEmail}`
              : 'Could not verify your Google account (authorize to continue).';

            google.script.run
              .withSuccessHandler(({year, week}) => {
                currentYear = year; currentWeek = week;
                yearEl.value = year; weekEl.value = week;

                fetchLives();
                safeLoad();
              })
              .withFailureHandler(showError)
              .getDefaultYearWeek();
          })
          .withFailureHandler(showError)
          .getViewerEmailPublic();
      }

      // ----- Load games -----
      function safeLoad() {
        msgEl.textContent = 'Loading…';
        msgEl.className = 'muted';
        gamesBox.textContent = 'Loading…';
        submitBtn.disabled = true;
        selected = null;

        const y = parseInt(yearEl.value, 10);
        const w = parseInt(weekEl.value, 10);
        const year = Number.isFinite(y) ? y : (new Date()).getFullYear();
        const week = Number.isFinite(w) && w >= 1 && w <= 22 ? w : 1;
        currentYear = year; currentWeek = week;

        google.script.run
          .withSuccessHandler((resp) => {
            const list = (resp && Array.isArray(resp.games)) ? resp.games : [];
            if (!list.length) { gamesBox.textContent = 'No games found.'; gamesBox.className = 'games'; return; }

            renderGames(list);
            gamesBox.className = 'games';
            msgEl.textContent = '';

            beginGate();
            refreshUsedTeams();        // -> gate.survivor = true
            fetchAndMarkCurrentPick(); // -> gate.saved    = true
            enforceUserPickLock();     // -> gate.lock     = true (+ uiLocked)

            fetchLives();
          })
          .withFailureHandler(showError)
          .getNflGamesLite(year, week);
      }

      // ----- Render games -----
      function renderGames(list) {
        const html = (list || []).map((g, idx) => {
          const away = g[0] || '', home = g[1] || '', iso = g[2] || '', when = g[3] || '';
          const awayLogo = g[4] || '', homeLogo = g[5] || '';
          const awayId = `g${idx}_away`, homeId = `g${idx}_home`;
          return `
            <div class="game" data-idx="${idx}">
              <div class="game-header">${when}</div>
              <div class="team-line">
                <span class="team-choice">
                  <span class="radio-box">
                    <input type="radio" name="team" id="${awayId}"
                           data-team="${away}" data-opp="${home}" data-iso="${iso}">
                    <span class="saved-dot" aria-hidden="true"></span>
                  </span>
                  ${awayLogo ? `<img class="logo" src="${awayLogo}" alt="${away} logo" loading="lazy">` : ''}
                  <label for="${awayId}">${away}</label>
                </span>
                <span class="at">AT</span>
                <span class="team-choice">
                  <span class="radio-box">
                    <input type="radio" name="team" id="${homeId}"
                           data-team="${home}" data-opp="${away}" data-iso="${iso}">
                    <span class="saved-dot" aria-hidden="true"></span>
                  </span>
                  ${homeLogo ? `<img class="logo" src="${homeLogo}" alt="${home} logo" loading="lazy">` : ''}
                  <label for="${homeId}">${home}</label>
                </span>
              </div>
            </div>
          `;
        }).join('');
        gamesBox.innerHTML = html;

        gamesBox.querySelectorAll('input[type="radio"][name="team"]').forEach(r => {
          r.addEventListener('change', () => {
            selected = [r.dataset.team, r.dataset.opp, r.dataset.iso];
            markSelections();
            updateSubmitEnabled();
          });
        });

        applyUsedTeamDisables();
        markSelections();
      }

      // ----- Survivor + kickoff visuals -----
      function refreshUsedTeams() {
        if (!currentYear || !viewerEmail) {
          usedTeams = new Set();
          gate.survivor = true;
          maybeEnablePicking();
          return;
        }
        google.script.run
          .withSuccessHandler(({teams}) => {
            usedTeams = new Set((teams || []).map(t => String(t).toUpperCase()));
            gate.survivor = true;
            applyUsedTeamDisables();
            markSelections();
            maybeEnablePicking();
          })
          .withFailureHandler(() => {
            usedTeams = new Set();
            gate.survivor = true;
            maybeEnablePicking();
          })
          .getUsedTeamsForViewer(currentYear);
      }

      function applyUsedTeamDisables() {
        const now = Date.now();
        const radios = gamesBox.querySelectorAll('input[type="radio"][name="team"]');
        const savedTeamU = currentPick && currentPick.team ? String(currentPick.team).toUpperCase() : null;

        radios.forEach(r => {
          const abbr = String(r.dataset.team || '').toUpperCase();
          const isoMs = r.dataset.iso ? new Date(r.dataset.iso).getTime() : NaN;

          const gameStarted = Number.isFinite(isoMs) && isoMs <= now;
          const isSaved = savedTeamU && abbr === savedTeamU;

          const taken = usedTeams.has(abbr);
          const survivorBlock = taken && !isSaved;

          const disable = survivorBlock || gameStarted;
          r.disabled = disable;

          const tc = r.closest('.team-choice');
          if (tc) {
            if (disable && !isSaved) tc.classList.add('hide-radio');
            else tc.classList.remove('hide-radio');
          }

          const label = gamesBox.querySelector(`label[for="${r.id}"]`);
          if (label) label.style.opacity = (disable && !isSaved) ? '0.5' : '1';
        });
      }

      // ----- Visuals (saved badge + grey follow + saved ghost) -----
      function markSelections() {
        gamesBox.querySelectorAll('.game.current').forEach(card => card.classList.remove('current'));
        gamesBox.querySelectorAll('.badge.current').forEach(b => b.remove());
        gamesBox.querySelectorAll('.team-choice.saved-ghost').forEach(tc => tc.classList.remove('saved-ghost'));

        const savedTeamU = currentPick && currentPick.team ? String(currentPick.team).toUpperCase() : null;
        const checked = gamesBox.querySelector('input[type="radio"][name="team"]:checked');
        const checkedU = checked ? String(checked.dataset.team || '').toUpperCase() : null;

        if (checked) {
          const card = checked.closest('.game');
          if (card) card.classList.add('current');
        }

        if (savedTeamU) {
          const savedRadio = Array.from(gamesBox.querySelectorAll('input[type="radio"][name="team"]'))
            .find(r => String(r.dataset.team || '').toUpperCase() === savedTeamU);
          if (savedRadio) {
            const savedCard = savedRadio.closest('.game');
            if (savedCard) {
              const badge = document.createElement('span');
              badge.className = 'badge current';
              badge.textContent = 'Current Selection';
              savedCard.appendChild(badge);
            }
            if (!checkedU || checkedU !== savedTeamU) {
              const teamChoice = savedRadio.closest('.team-choice');
              if (teamChoice) teamChoice.classList.add('saved-ghost');
            }
          }
        }
      }

      // ----- Saved pick preload -----
      function fetchAndMarkCurrentPick() {
        if (!currentYear || !currentWeek) return;

        google.script.run
          .withSuccessHandler((pick) => {
            currentPick = (pick && pick.team) ? pick : null;

            if (currentPick) {
              const teamU = String(currentPick.team).toUpperCase();
              const radios = Array.from(gamesBox.querySelectorAll('input[type="radio"][name="team"]'));
              const r = radios.find(inp => String(inp.dataset.team || '').toUpperCase() === teamU);
              if (r) {
                r.checked = true;
                selected = [r.dataset.team, r.dataset.opp, r.dataset.iso];

                const card = r.closest('.game');
                if (card && card.parentElement === gamesBox) {
                  gamesBox.prepend(card);
                  gamesBox.scrollTop = 0;
                }
              }
            }

            applyUsedTeamDisables();
            markSelections();
            enforceUserPickLock();

            gate.saved = true;
            maybeEnablePicking();
          })
          .withFailureHandler(() => {
            currentPick = null;
            applyUsedTeamDisables();
            markSelections();
            gate.saved = true;
            maybeEnablePicking();
          })
          .getCurrentPickForViewerPublic(currentYear, currentWeek);
      }

      // ----- Lock handling -----
      function enforceUserPickLock() {
        if (!currentYear || !currentWeek) return;

        google.script.run
          .withSuccessHandler(({team, opponent, state, kickoffISO}) => {
            const locked = (state && state.toLowerCase() !== 'pre') ||
                           (kickoffISO && new Date(kickoffISO).getTime() <= Date.now());

            if (locked) {
              const savedU = String(team || '').toUpperCase();
              const radios = gamesBox.querySelectorAll('input[type="radio"][name="team"]');

              radios.forEach(r => {
                const abbr = String(r.dataset.team || '').toUpperCase();
                const tc = r.closest('.team-choice');
                if (abbr === savedU) {
                  r.checked = true;
                  r.disabled = true;
                  if (tc) tc.classList.remove('hide-radio');
                } else {
                  r.disabled = true;
                  if (tc) tc.classList.add('hide-radio');
                }
              });

              submitBtn.disabled = true;

              const t = team ? ` (${team})` : '';
              msgEl.textContent = `Your pick${t} is locked (game started or finished).`;
              msgEl.className = 'error';

              gate.uiLocked = true;
            }

            markSelections();
            gate.lock = true;
            maybeEnablePicking();
          })
          .withFailureHandler(() => {
            gate.lock = true;
            maybeEnablePicking();
          })
          .getCurrentPickForViewerPublic(currentYear, currentWeek);
      }

      // ----- Submit -----
      function onSubmit() {
        msgEl.className = 'muted';
        msgEl.textContent = '';

        if (!viewerEmail) { setError('Please authorize access to your Google email to make a pick.'); return; }
        if (!selected)     { setError('Select a team.'); return; }

        const team = selected[0];
        const opponent = selected[1];
        const kickoffISO = selected[2] || '';
        const lockAtKickoff = !!lockAtKickoffEl.checked;

        submitBtn.disabled = true;
        msgEl.textContent = 'Submitting…';

        google.script.run
          .withSuccessHandler(() => {
            msgEl.textContent = `Pick saved for Week ${currentWeek}, ${currentYear}!`;
            msgEl.className = 'success';
            submitBtn.disabled = false;

            refreshUsedTeams();
            fetchAndMarkCurrentPick();
            enforceUserPickLock();
            fetchLives();
          })
          .withFailureHandler(showError)
          .submitPick(currentYear, currentWeek, viewerEmail, team, opponent, kickoffISO, lockAtKickoff);
      }

      // ----- Errors -----
      function setError(text) {
        gamesBox.textContent = text;
        gamesBox.className = 'games error';
        msgEl.textContent = text;
        msgEl.className = 'error';
        submitBtn.disabled = true;
      }
      function showError(err) {
        const text = (err && err.message) ? err.message : String(err || 'Unknown error');
        setError(text);
      }
    </script>
  </body>
</html>
